<!DOCTYPE html>
<html>

<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <title>Shotclock</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⏱️</text></svg>">
  <style>
    .red {
      color: red;
    }
  </style>
</head>

<body>
  Room: <input id="room" type="text"></input>
  <button onclick="join()">Join</button>

  <br /><br /><br />
  <span id="score" style="font-size: 60pt;"></span>
  <br />
  <span id="game" style="font-size: 60pt;"></span>
  <br />
  <span id="shotclock" style="font-size: 60pt;"></span>
  <br />
  <button onclick="start();">Start</button>
  <button onclick="stop();">Stop</button>
  <button onclick="reset();">Reset</button>
  <br />
  <button onclick="goalH(1);">Goal Home +</button>
  <button onclick="goalA(1);">Goal Away +</button>
  <br />
  <button onclick="goalH(-1);">Goal Home -</button>
  <button onclick="goalA(-1);">Goal Away -</button>

  <script>
    var ws;

    function join() {
      var room = document.getElementById("room").value;
      if (room.trim() === "") {
        alert("Room can't be empty")
        return;
      }

      if (ws !== undefined)
        ws.close();
      ws = new WebSocket("wss://tobias-reinke.de/shotclock/" + room);
      ws.onerror = function (error) {
        console.log(error);
      };
      ws.onmessage = function (event) {
        var id = event.data.substring(0, 1);
        var split = event.data.substring(1).split(";");
        switch (id) {
          case "t":
            var game = split[0];
            var min = String(Math.floor(game / 60)).padStart(2, '0');
            var sec = String(game % 60).padStart(2, '0');
            document.getElementById('game').innerHTML = min + ":" + sec;

            var shotclock = split[1];
            document.getElementById('shotclock').innerHTML = shotclock;
            if (shotclock == 0)
              alarm();
            else
              deactivateAlarm();
            break;
          case "s":
            var score1 = split[0];
            var score2 = split[1];
            document.getElementById('score').innerHTML = score1 + " - " + score2;
            break;
        }
      }
    }

    var alarmInterval;
    function alarm() {
      if (alarmInterval === undefined) {
        alarmInterval = setInterval(function () {
          var element = document.getElementById('shotclock');
          if (element.classList.contains('red'))
            element.classList.remove('red');
          else
            element.classList.add('red');
        }, 500);
      }
    }

    function deactivateAlarm() {
      if (alarmInterval !== undefined) {
        clearInterval(alarmInterval);
        alarmInterval = undefined;
      }
      document.getElementById('shotclock').classList.remove('red');
    }

    function start() {
      ws.send('start');
    }
    function stop() {
      ws.send('stop');
    }
    function reset() {
      deactivateAlarm();
      ws.send('reset');
    }

    function goalH(plusminus) {
      if (plusminus > 0)
        ws.send('goalH+');
      else if (plusminus < 0)
        ws.send('goalH-');
    }
    function goalA(plusminus) {
      if (plusminus > 0)
        ws.send('goalA+');
      else if (plusminus < 0)
        ws.send('goalA-');
    }
  </script>
</body>

</html>